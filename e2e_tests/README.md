# e2elive

An integration testing tool. It leverages an artifact generated by the go-algorand integration tests to ensure all features are exercised.

# Usage

A python virtual environment is highly encouraged.

## Setup environment with venv
```sh
cd e2e_tests

# create venv dir, I believe you could specify the version of python here
python3 -m venv venv_dir

# This command depends on your shell
source venv_dir/bin/activate.fish

# Install 'e2elive' and 'e2econduit'
python3 -m pip install .
```

## Running locally


### e2elive

This tests runs the `algorand-indexer` binary. Depending on what you're doing, you may want to use a different value for `--s3-source-net`. After the test finishes, a few simple queries are executed.

This command requires a postgres database, you can run one in docker:

```sh
docker run --rm -it --name some-postgres -p 5555:5432 -e POSTGRES_PASSWORD=pgpass -e POSTGRES_USER=pguser -e POSTGRES_DB=mydb postgres
```

Running e2elive

**Note**: you will need to restart this container between tests, otherwise the database will already be initialized. Being out of sync with the data directory may cause unexpected behavior and failing tests.
```sh
e2elive --connection-string "host=127.0.0.1 port=5555 user=pguser password=pgpass dbname=mydb" --s3-source-net "fafa8862/rel-nightly" --indexer-bin ../cmd/algorand-indexer/algorand-indexer --indexer-port 9890
```

### e2econduit

This runs a series of pipeline scenarios with conduit. Each module manages its own resources and may have dependencies. For example the PostgreSQL exporter starts a docker container to initialize a database server.
```sh
e2econduit --s3-source-net rel-nightly --conduit-bin ../cmd/conduit/conduit
```

## Run with docker

The e2elive script has a docker configuration available.

```sh
make e2e
```

You may need to set (and export) the `CI_E2E_FILENAME` environment variable.

```sh
export CI_E2E_FILENAME=rel-nightly
make e2e
```

Alternatively, modify `e2e_tests/docker/indexer/Dockerfile` by swapping out `$CI_E2E_FILENAME` with the test artifact you want to use. See `.circleci/config.yml` for the current values used by CI.
